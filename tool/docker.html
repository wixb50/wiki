<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/wiki/static/css/colorful.css">
    <link rel="Stylesheet" type="text/css" href="/wiki/static/css/style.css">
    <link rel="shortcut icon" href="/wiki/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/wiki/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>Docker - Wiki · Elegancetse Tse</title>
    <meta name="keywords" content="wiki, makrdown, linux, python, ops, simiki"/>
    <meta name="description" content="Stay hungry,Stay foolish."/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
  </head>

  <body>
    <div id="container" class="typo">
      
<div id="header">
  <div id="post-nav">
    <a href="/wiki/">Wiki · Elegancetse Tse</a>
    &nbsp;&#187;&nbsp;
    <a href="/wiki/#tool">tool</a>
    &nbsp;&#187;&nbsp;Docker
    <span class="updated">Updated&nbsp;
    2016-03-07 23:39
    
    </span>
  </div>
</div>
<div class="clearfix"></div>
<div id="content">
  <p><a href="https://www.docker.com/">Docker</a> Build, Ship, Run; An open platform for distributed applications for developers and sysadmins</p>
<h2 id="_1">前言</h2>
<p>下面5个链接是2014年的博客, 基于0.10.0, 当前是1.9.x (有些已经失效)</p>
<ul>
<li><a href="http://blog.tankywoo.com/docker/2014/05/08/docker-1-start.html">Docker 1 -- 开始</a></li>
<li><a href="http://blog.tankywoo.com/docker/2014/05/08/docker-2-dockerfile.html">Docker 2 -- 关于Dockerfile</a></li>
<li><a href="http://blog.tankywoo.com/docker/2014/05/08/docker-3-docker-registry.html">Docker 3 -- 自建Docker Registry</a></li>
<li><a href="http://blog.tankywoo.com/docker/2014/05/08/docker-4-summary.html">Docker 4 -- 总结</a></li>
<li><a href="http://blog.tankywoo.com/2014/12/22/docker-bridge-network.html">Docker 网络桥接</a></li>
</ul>
<p>入门参考:</p>
<ul>
<li><a href="http://docs.docker.com/linux/started/">Docker - Get Started</a></li>
<li><a href="https://docs.docker.com/">Docker - Docs</a></li>
</ul>
<p>其实以前入门时, 有一个Interactive commandline tutorial, 我觉得挺好的, 但是现在没了.</p>
<p>那个时候docker官网的域名还是docker.io, 现在已经把docker.com拿下了, 变化还是挺大的.</p>
<h2 id="_2">安装</h2>
<div class="hlcode"><pre><span class="n">curl</span> <span class="o">-</span><span class="n">sSL</span> <span class="n">https</span><span class="o">:</span><span class="c1">//get.docker.com/ | sh</span>
</pre></div>


<h2 id="_3">遇到的问题</h2>
<h3 id="docker">Docker容器内不能访问外网</h3>
<p>编辑系统网络配置</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">sudo</span> <span class="n">gedit</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">NetworkManager</span><span class="o">/</span><span class="n">NetworkManager</span><span class="p">.</span><span class="n">conf</span>
</pre></div>


<p>注释以下行后重启</p>
<div class="hlcode"><pre><span class="cp">#dns=dnsmasq</span>

<span class="err">$</span> <span class="n">sudo</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">network</span><span class="o">-</span><span class="n">manager</span> <span class="n">restart</span>
</pre></div>


<h2 id="loop-module">loop module</h2>
<p>Gentoo下安装docker后启动报错, 看日志:</p>
<blockquote>
<p>level=info msg="Listening for HTTP on unix (/var/run/docker.sock)"
level=error msg="There are no more loopback devices available."
level=fatal msg="Error starting daemon: error initializing graphdriver: loopback mounting failed"</p>
</blockquote>
<p>原因是没有加载<code>loop</code>模块. 在<code>/etc/conf.d/modules</code> 中加入模块:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">cat</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">conf</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">modules</span>
<span class="cp"># You can define a list modules for a specific kernel version,</span>
<span class="cp"># a released kernel version, a main kernel version or just a list.</span>
<span class="cp"># The most specific versioned variable will take precedence.</span>
<span class="cp">#modules_2_6_23_gentoo_r5=&quot;ieee1394 ohci1394&quot;</span>
<span class="cp">#modules_2_6_23=&quot;tun ieee1394&quot;</span>
<span class="cp">#modules_2_6=&quot;tun&quot;</span>
<span class="cp">#modules_2=&quot;ipv6&quot;</span>
<span class="cp">#modules=&quot;ohci1394&quot;</span>

<span class="cp"># You can give modules a different name when they load - the new name</span>
<span class="cp"># will also be used to pick arguments below.</span>
<span class="cp">#modules=&quot;dummy:dummy1&quot;</span>

<span class="cp"># Give the modules some arguments if needed, per version if necessary.</span>
<span class="cp"># Again, the most specific versioned variable will take precedence.</span>
<span class="cp">#module_ieee1394_args=&quot;debug&quot;</span>
<span class="cp">#module_ieee1394_args_2_6_23_gentoo_r5=&quot;debug2&quot;</span>
<span class="cp">#module_ieee1394_args_2_6_23=&quot;debug3&quot;</span>
<span class="cp">#module_ieee1394_args_2_6=&quot;debug4&quot;</span>
<span class="cp">#module_ieee1394_args_2=&quot;debug5&quot;</span>

<span class="cp"># You should consult your kernel documentation and configuration</span>
<span class="cp"># for a list of modules and their options.</span>
<span class="n">modules</span><span class="o">=</span><span class="s">&quot;loop&quot;</span>
</pre></div>


<p>然后加载模块: <code>modprobe loop</code></p>
<h2 id="_4">内核支持</h2>
<p>一个是iptables nat表, 编译内核时忘了打开nat支持了, 导致docker启动不了(docker开启不修改iptables选项应该就没事了).</p>
<p>打开内核选项:</p>
<div class="hlcode"><pre><span class="n">CONFIG_IP_NF_NAT</span>
</pre></div>


<p><a href="https://forums.gentoo.org/viewtopic-t-1009770.html?sid=7822e8eefcdb28edcedf9db7526b7b1e">can't initialize iptables table <code>nat'</code></a></p>
<p>安装完docker顺便发现有如下提示:</p>
<div class="hlcode"><pre><span class="o">*</span> <span class="n">Messages</span> <span class="k">for</span> <span class="n">package</span> <span class="n">app</span><span class="o">-</span><span class="n">emulation</span><span class="o">/</span><span class="n">docker</span><span class="o">-</span><span class="mf">1.10.0</span><span class="o">:</span>

<span class="o">*</span>   <span class="n">CONFIG_IP_NF_TARGET_MASQUERADE</span><span class="o">:</span>     <span class="n">is</span> <span class="n">not</span> <span class="n">set</span> <span class="n">when</span> <span class="n">it</span> <span class="n">should</span> <span class="n">be</span><span class="p">.</span>
<span class="o">*</span>   <span class="n">CONFIG_CGROUP_HUGETLB</span><span class="o">:</span>      <span class="n">is</span> <span class="n">not</span> <span class="n">set</span> <span class="n">when</span> <span class="n">it</span> <span class="n">should</span> <span class="n">be</span><span class="p">.</span>
<span class="o">*</span>   <span class="n">CONFIG_CGROUP_NET_PRIO</span><span class="o">:</span>     <span class="n">is</span> <span class="n">not</span> <span class="n">set</span> <span class="n">when</span> <span class="n">it</span> <span class="n">should</span> <span class="n">be</span><span class="p">.</span>
<span class="o">*</span> <span class="n">Please</span> <span class="n">check</span> <span class="n">to</span> <span class="n">make</span> <span class="n">sure</span> <span class="n">these</span> <span class="n">options</span> <span class="n">are</span> <span class="n">set</span> <span class="n">correctly</span><span class="p">.</span>
<span class="o">*</span> <span class="n">Failure</span> <span class="n">to</span> <span class="k">do</span> <span class="n">so</span> <span class="n">may</span> <span class="n">cause</span> <span class="n">unexpected</span> <span class="n">problems</span><span class="p">.</span>
</pre></div>


<p>就顺便一起重新编译内核了.</p>
<p>官方也提供了内核参数检查的脚本 <a href="https://github.com/docker/docker/blob/master/contrib/check-config.sh">docker/contrib/check-config.sh</a></p>
<h2 id="docker_1">更改docker数据存储目录</h2>
<p>docker的默认存储路径为<code>/var/lib/docker</code>，但是有时候想更改目录：</p>
<ul>
<li>Ubuntu/Debian:编辑<code>/etc/default/docker</code>文件，更改<code>DOCKER_OPTS="-dns 8.8.8.8 -dns 8.8.4.4 -g /mnt"</code>为目录.</li>
<li>Fedora/Centos: 编辑<code>/etc/sysconfig/docker</code>文件，更改参数为<code>other_args="-g /var/lib/testdir"</code>.</li>
</ul>
<h2 id="_5">一些链接</h2>
<ul>
<li><a href="https://www.gitbook.com/book/yeasy/docker_practice/details">Docker —— 从入门到实践</a></li>
<li><a href="https://dashboard.daocloud.io/packages">国内daocloud的一些镜像</a> 国内现在没找到什么好的仓库, 这个算一个, 就是镜像略少</li>
</ul>
  
</div>
    </div>
    <div id="footer">
      <div class="footer-left">
        <p>
        Copyright © 2016 Elegancetse Tse.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.
        Theme by <a href="https://git.coding.net/tankywoo/yasimple_x2.git" target="_blank">YASimple_X2</a>.
        </p>
      </div> <!-- end footer-left -->
      <div class="footer-right">
        <p>Site Generated 2016-06-27 14:17:16</p>
      </div> <!-- end footer-right -->
    </div>
  </body>
</html>