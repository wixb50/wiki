<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/wiki/static/css/colorful.css">
    <link rel="Stylesheet" type="text/css" href="/wiki/static/css/style.css">
    <link rel="shortcut icon" href="/wiki/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/wiki/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>runit - Wiki · Elegancetse Tse</title>
    <meta name="keywords" content="wiki, makrdown, linux, python, ops, simiki"/>
    <meta name="description" content="Stay hungry,Stay foolish."/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
  </head>

  <body>
    <div id="container" class="typo">
      
<div id="header">
  <div id="post-nav">
    <a href="/wiki/">Wiki · Elegancetse Tse</a>
    &nbsp;&#187;&nbsp;
    <a href="/wiki/#tool">tool</a>
    &nbsp;&#187;&nbsp;runit
    <span class="updated">Updated&nbsp;
    2018-05-30 13:31
    </span>
  </div>
</div>
<div class="clearfix"></div>
<div id="content">
  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#runit">runit服务管理</a><ul>
<li><a href="#runit_1">关于runit</a></li>
<li><a href="#_1">安装与环境搭建</a></li>
<li><a href="#_2">服务创建</a><ul>
<li><a href="#_3">新建一个服务</a></li>
<li><a href="#_4">配置服务日志输出(可选)</a></li>
</ul>
</li>
<li><a href="#_5">管理服务</a></li>
</ul>
</li>
<li><a href="#_6">参考文档</a></li>
</ul>
</div>
<h2 id="runit"><code>runit</code>服务管理</h2>
<h3 id="runit_1">关于<code>runit</code></h3>
<p>runit是一个用于服务监控的UNIX软件，它提供以下两种服务：</p>
<ul>
<li>当服务器启动的时候启动定义好的服务。</li>
<li>监控运行的服务，当服务发生意外中断的时候，自动重启服务。</li>
</ul>
<h3 id="_1">安装与环境搭建</h3>
<p>首先确保系统安装了runit，大多数Linux版本的软件仓库里都包哈了runit包。例如，如果你的系统是基于Debian的，则可以使用下面的命令进行安装：</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">runit</span>
</pre></div>


<p>如果是centos，则可以使用yum进行安装，但是默认情况下centos软件仓库里并没有runit，所以需要先配置相应的仓库：</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">curl</span> <span class="o">-</span><span class="n">s</span> <span class="n">https</span><span class="o">:</span><span class="c1">//packagecloud.io/install/repositories/imeyer/runit/script.rpm.sh | sudo bash</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">yum</span> <span class="n">install</span> <span class="n">runit</span><span class="o">-</span><span class="mf">2.1.1</span><span class="o">-</span><span class="mf">7.</span><span class="n">el7</span><span class="p">.</span><span class="n">centos</span><span class="p">.</span><span class="n">x86_64</span>
</pre></div>


<p>运行以下命令来检查是否已经安装了runit并且系统已经运行了runit。</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">ps</span> <span class="o">-</span><span class="n">ef</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">runsvdir</span>
<span class="cp"># 输出如下</span>
<span class="n">root</span> <span class="mi">2783</span> <span class="mi">1</span> <span class="mi">0</span> <span class="mi">15</span><span class="o">:</span><span class="mi">34</span> <span class="o">?</span> <span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span> <span class="n">runsvdir</span> <span class="o">-</span><span class="n">P</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">service</span> <span class="n">log</span><span class="o">:</span>
</pre></div>


<p>runsvdir其实是一套组件，这些组件可以满足用户的各种需求，核心组件包括了runsvdir，runsv， chpst，svlogd以及sv。</p>
<h3 id="_2">服务创建</h3>
<p>注意输出结果中的<code>runsvdir -P /etc/service log:.......</code>， 它的意思是runsvdir会监控/etc/service/目录下的文件，这些文件用于配置被监控的服务。</p>
<p>被监控的服务是通过在/etc/service目录下创建子目录，并添加可执行脚本run来实现的。</p>
<p>当runsvdir发现新的配置文件时，它就会自动启动一个<code>runsv</code>进程来管理这个配置的服务。</p>
<p>确保存在/etc/service，如果不存在，则使用mkdir创建相应目录：</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">mkdir</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">service</span>
</pre></div>


<h4 id="_3">新建一个服务</h4>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">mkdir</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">service</span><span class="o">/</span><span class="n">template</span>
<span class="err">$</span> <span class="n">touch</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">service</span><span class="o">/</span><span class="n">template</span><span class="o">/</span><span class="n">run</span> <span class="o">&amp;&amp;</span> <span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">service</span><span class="o">/</span><span class="n">template</span><span class="o">/</span><span class="n">run</span>
</pre></div>


<p>配置服务启动,编辑<code>/etc/service/template/run</code></p>
<table class="hlcodetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="hlcode"><pre><span class="c">#!/bin/sh -e</span>
<span class="nb">exec </span>2&gt;&amp;1
<span class="nb">exec </span>chpst -u USER COMMAND
</pre></div>
</td></tr></table>

<p>这个脚本首先将标准错误输出流输出到标准输出流，然后执行chpst命令。chpst命令用来指定使用哪个用户执行命令。由于run脚本默认被root用户执行，通过chpst可以将run配置为普通用户来执行。通过man命令可以查看chpst的更多信息。</p>
<p>当runsvdir检查到/etc/service目录下包含一个新的目录时，runsvdir会启动一个runsv进程来执行和监控run脚本。通过man命令查看runsv的更多信息。</p>
<h4 id="_4">配置服务日志输出(可选)</h4>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">mkdir</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">service</span><span class="o">/</span><span class="n">template</span><span class="o">/</span><span class="n">log</span>
<span class="err">$</span> <span class="n">touch</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">service</span><span class="o">/</span><span class="n">template</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">run</span> <span class="o">&amp;&amp;</span> <span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">service</span><span class="o">/</span><span class="n">template</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">run</span>
</pre></div>


<p>编辑<code>/etc/service/template/log/run</code></p>
<table class="hlcodetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="hlcode"><pre><span class="c">#!/bin/sh</span>
<span class="nb">exec </span>chpst -u USER svlogd -tt LOGDIR
</pre></div>
</td></tr></table>

<p>上面的脚本使用chpst启动一个svlogd守护进程，该进程将日志信息写到LOGDIR目录中。使用man命令获取更多关于svlodg的信息。</p>
<p>当runsvdir在/etc/service/目录中发现新的配置时，它会继续查找子目录log，如果找到了则启动runsv进程来执行和监控log目录下的run脚本。</p>
<h3 id="_5">管理服务</h3>
<ul>
<li>检查服务的状态</li>
</ul>
<div class="hlcode"><pre><span class="n">sv</span> <span class="n">status</span> <span class="n">example</span>
</pre></div>


<ul>
<li>停止服务</li>
</ul>
<div class="hlcode"><pre><span class="n">sv</span> <span class="n">stop</span> <span class="n">example</span>
</pre></div>


<p>停止服务之后不会再输出日志信息，也不会再自动重启。</p>
<ul>
<li>重启服务</li>
</ul>
<div class="hlcode"><pre><span class="n">sv</span> <span class="n">restart</span> <span class="n">example</span>
</pre></div>


<h2 id="_6">参考文档</h2>
<ul>
<li><a href="https://segmentfault.com/a/1190000006644578">runit 快速入门</a></li>
</ul>
  
</div>
    </div>
    <div id="footer">
      <div class="footer-left">
        <p>
        Copyright © 2018 Elegancetse Tse.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.
        Theme by <a href="https://github.com/tankywoo/yasimple_x2" target="_blank">YASimple_X2</a>.
        </p>
      </div> <!-- end footer-left -->
      <div class="footer-right">
        <p>Site Generated 2018-05-30 02:02:05</p>
      </div> <!-- end footer-right -->
    </div>

    
    
  </body>
</html>